<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!-- Fragment: Exams Section -->
<div th:fragment="section" class="section-block section-exams">
  <div class="section" id="examsSection">
    <div class="top-action">
      <h2>Bài kiểm tra</h2>
      <a class="create-btn" th:href="@{/teacher/exams/new}">Tạo bài kiểm tra +</a>
    </div>

    <div class="divider"></div>

    <!-- Toast / alert -->
    <div th:if="${toast}" class="alert success" th:text="${toast}"></div>
    <div th:if="${examSuccess}" class="alert success" th:text="${examSuccess}"></div>
    <div th:if="${examError}" class="alert error" th:text="${examError}"></div>

    <!-- Empty -->
    <div th:if="${#lists.isEmpty(exams)}" class="empty-box">
      <img src="/img/empty-quiz.png" alt="Không có bài kiểm tra">
      <p>Chưa có bài kiểm tra nào</p>
    </div>

    <!-- List -->
    <div th:if="${!#lists.isEmpty(exams)}" class="exam-grid">

      <!-- Card (div clickable) -->
      <div class="exam-card"
           th:each="exam : ${exams}"
           th:attr="data-href=@{'/teacher/exams/' + ${exam.id} + '/edit'}"
           role="link"
           tabindex="0">

        <div class="exam-card-header">
          <!-- status fallback nếu null -->
          <div class="exam-status-badge"
               th:with="st=${exam.status != null ? exam.status : 'draft'}"
               th:classappend="${st == 'published' ? 'badge-published' :
                               st == 'draft' ? 'badge-draft' :
                               st == 'ongoing' ? 'badge-ongoing' : 'badge-ended'}">

            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>

            <span th:text="${st == 'published' ? 'Đã công bố' :
                           st == 'draft' ? 'Bản nháp' :
                           st == 'ongoing' ? 'Đang diễn ra' :
                           st == 'ended' ? 'Đã kết thúc' : 'Chưa rõ'}">Status</span>
          </div>

          <div class="exam-card-actions">
            <!-- Edit: dùng link luôn cho chắc -->
            <a class="btn-icon btn-edit-exam"
               th:href="@{'/teacher/exams/' + ${exam.id} + '/edit'}"
               title="Chỉnh sửa"
               aria-label="Chỉnh sửa">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </a>

            <!-- Delete -->
            <button type="button"
                    class="btn-icon btn-delete-exam"
                    th:attr="data-exam-id=${exam.id},
                             data-exam-title=${(exam.title != null && !#strings.isEmpty(exam.title)) ? exam.title : '(Chưa đặt tên)'}"
                    title="Xóa"
                    aria-label="Xóa">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>

        <div class="exam-card-body">
          <h3 class="exam-card-title" th:text="${exam.title != null && !#strings.isEmpty(exam.title) ? exam.title : '(Chưa đặt tên)'}">
            Tên bài kiểm tra
          </h3>

          <p class="exam-card-description" th:text="${exam.description != null && !#strings.isEmpty(exam.description) ? exam.description : 'Chưa có mô tả'}">
            Mô tả
          </p>

          <div class="exam-card-meta">
            <span class="exam-meta-item" th:if="${exam.category != null}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
              </svg>
              <span th:text="${exam.category.name}">Danh mục</span>
            </span>

            <span class="exam-meta-item">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              <span th:text="${exam.timeLimit != null ? exam.timeLimit + ' phút' : 'Không giới hạn'}">Không giới hạn</span>
            </span>
          </div>
        </div>

        <div class="exam-card-footer" th:if="${exam.createdAt != null}">
          <span class="exam-card-date">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span th:text="${#temporals.format(exam.createdAt, 'dd/MM/yyyy')}">01/01/2024</span>
          </span>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Fragment: Exams Modals -->
<div th:fragment="modals">
  <div class="modal-overlay" id="deleteExamModal">
    <div class="modal-container" style="max-width: 500px;">
      <div class="modal-topbar">
        <h3>Xác nhận xóa bài kiểm tra</h3>
        <span class="close-btn" id="closeDeleteExamModal">&times;</span>
      </div>
      <div class="modal-body">
        <p style="margin: 0 0 20px; color: #555;">
          Bạn có chắc chắn muốn xóa bài kiểm tra <strong id="deleteExamTitle"></strong>?
        </p>
        <p style="margin: 0 0 20px; color: #d9534f; font-size: 14px;">⚠️ Hành động này không thể hoàn tác!</p>

        <form id="deleteExamForm" method="post" th:action="@{/teacher/exams/delete}">
          <input type="hidden" id="deleteExamId" name="id">
          <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

          <div class="modal-footer" style="margin-top: 0; padding-top: 0; border-top: none;">
            <button type="button" class="btn-secondary" id="cancelDeleteExamBtn">Hủy</button>
            <button type="submit" class="btn-danger" id="confirmDeleteBtn">Xóa bài kiểm tra</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script th:fragment="scripts">
document.addEventListener('DOMContentLoaded', function() {

  // Click vào card -> đi edit (trừ khi click vào actions)
  document.querySelectorAll('.exam-card').forEach(card => {
    const go = () => {
      const href = card.getAttribute('data-href');
      if (href) window.location.href = href;
    };

    card.addEventListener('click', function(e) {
      if (e.target.closest('.exam-card-actions')) return;
      go();
    });

    card.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        go();
      }
    });
  });

  const deleteExamModal = document.getElementById('deleteExamModal');

  document.querySelectorAll('.btn-delete-exam').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();

      const examId = this.getAttribute('data-exam-id');
      const examTitle = this.getAttribute('data-exam-title');

      document.getElementById('deleteExamId').value = examId;
      document.getElementById('deleteExamTitle').textContent = examTitle || '';

      deleteExamModal.classList.add('show');

      const confirmBtn = document.getElementById('confirmDeleteBtn');
      if (confirmBtn) confirmBtn.focus();
    });
  });

  function closeDeleteModal() {
    deleteExamModal.classList.remove('show');
  }

  const closeBtn = document.getElementById('closeDeleteExamModal');
  const cancelBtn = document.getElementById('cancelDeleteExamBtn');

  if (closeBtn) closeBtn.addEventListener('click', closeDeleteModal);
  if (cancelBtn) cancelBtn.addEventListener('click', closeDeleteModal);

  if (deleteExamModal) {
    deleteExamModal.addEventListener('click', function(e) {
      if (e.target === deleteExamModal) closeDeleteModal();
    });
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && deleteExamModal.classList.contains('show')) {
      closeDeleteModal();
    }
  });

  const deleteForm = document.getElementById('deleteExamForm');
  if (deleteForm) {
    deleteForm.addEventListener('submit', function() {
      const btn = document.getElementById('confirmDeleteBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Đang xóa...';
      }
    });
  }
});
</script>

</body>
</html>
