<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!-- Fragment: Categories Section -->
<div th:fragment="section" class="section-block section-categories">
    <div class="section" id="categoriesSection">
        <div class="top-action">
            <h2>Danh mục</h2>
            <button class="create-btn" id="openAddCategoryModal" type="button">Thêm danh mục +</button>
        </div>
        <div class="divider"></div>

        <div th:if="${categorySuccess}" class="alert success" th:text="${categorySuccess}"></div>
        <div th:if="${categoryError}" class="alert error" th:text="${categoryError}"></div>

        <div th:if="${#lists.isEmpty(categories)}" class="empty-box">
            <img src="/img/empty-quiz.png" alt="Không có danh mục">
            <p>Chưa có danh mục nào</p>
        </div>

        <div th:if="${!#lists.isEmpty(categories)}" class="category-grid">
            <div class="category-card" th:each="c : ${categories}">
                <div class="category-card-header">
                    <div class="category-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </div>
                    <div class="category-card-actions">
                        <button class="btn-icon btn-edit"
                                th:data-category-id="${c.id}"
                                th:data-category-name="${c.name}"
                                th:data-category-description="${c.description}"
                                title="Chỉnh sửa">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-icon btn-delete"
                                th:data-category-id="${c.id}"
                                th:data-category-name="${c.name}"
                                title="Xóa">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="category-card-body">
                    <h3 class="category-card-title" th:text="${c.name}">Tên danh mục</h3>
                    <p class="category-card-description" th:text="${c.description ?: 'Chưa có mô tả'}">Mô tả danh mục</p>
                </div>
                <div class="category-card-footer">
                    <span class="category-card-date" th:if="${c.createdAt}">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span th:text="${#temporals.format(c.createdAt, 'dd/MM/yyyy')}">01/01/2024</span>
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fragment: Categories Modals -->
<div th:fragment="modals">
    <!-- Modal thêm danh mục -->
    <div class="modal-overlay" id="addCategoryModal">
        <div class="modal-container">
            <div class="modal-topbar">
                <h3>Thêm danh mục mới</h3>
                <span class="close-btn" id="closeCategoryModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm" method="post" action="/teacher/categories/create">
                    <div class="form-group">
                        <label for="categoryName">Tên danh mục *</label>
                        <input type="text" id="categoryName" name="name" class="input" required placeholder="Nhập tên danh mục">
                    </div>

                    <div class="form-group">
                        <label for="categoryDescription">Mô tả</label>
                        <textarea id="categoryDescription" name="description" class="input" rows="3" placeholder="Nhập mô tả danh mục"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" id="cancelCategoryBtn">Hủy</button>
                        <button type="submit" class="btn-primary">Thêm danh mục</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa danh mục -->
    <div class="modal-overlay" id="editCategoryModal">
        <div class="modal-container">
            <div class="modal-topbar">
                <h3>Chỉnh sửa danh mục</h3>
                <span class="close-btn" id="closeEditCategoryModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm" method="post" action="/teacher/categories/update">
                    <input type="hidden" id="editCategoryId" name="id">

                    <div class="form-group">
                        <label for="editCategoryName">Tên danh mục *</label>
                        <input type="text" id="editCategoryName" name="name" class="input" required placeholder="Nhập tên danh mục">
                    </div>

                    <div class="form-group">
                        <label for="editCategoryDescription">Mô tả</label>
                        <textarea id="editCategoryDescription" name="description" class="input" rows="3" placeholder="Nhập mô tả danh mục"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" id="cancelEditCategoryBtn">Hủy</button>
                        <button type="submit" class="btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div class="modal-overlay" id="deleteCategoryModal">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-topbar">
                <h3>Xác nhận xóa danh mục</h3>
                <span class="close-btn" id="closeDeleteCategoryModal">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin: 0 0 20px; color: #555;">Bạn có chắc chắn muốn xóa danh mục <strong id="deleteCategoryName"></strong>?</p>
                <p style="margin: 0 0 20px; color: #d9534f; font-size: 14px;">⚠️ Hành động này không thể hoàn tác!</p>

                <form id="deleteCategoryForm" method="post" action="/teacher/categories/delete">
                    <input type="hidden" id="deleteCategoryId" name="id">

                    <div class="modal-footer" style="margin-top: 0; padding-top: 0; border-top: none;">
                        <button type="button" class="btn-secondary" id="cancelDeleteCategoryBtn">Hủy</button>
                        <button type="submit" class="btn-danger">Xóa danh mục</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:fragment="scripts">
// Categories management scripts
document.addEventListener('DOMContentLoaded', function() {
    const addCategoryModal = document.getElementById('addCategoryModal');
    const editCategoryModal = document.getElementById('editCategoryModal');
    const deleteCategoryModal = document.getElementById('deleteCategoryModal');

    // Open add category modal
    const openAddCategoryBtn = document.getElementById('openAddCategoryModal');
    if (openAddCategoryBtn) {
        openAddCategoryBtn.addEventListener('click', () => {
            addCategoryModal.classList.add('show');
        });
    }

    // Close add category modal
    const closeCategoryModal = document.getElementById('closeCategoryModal');
    const cancelCategoryBtn = document.getElementById('cancelCategoryBtn');

    if (closeCategoryModal) {
        closeCategoryModal.addEventListener('click', () => {
            addCategoryModal.classList.remove('show');
        });
    }

    if (cancelCategoryBtn) {
        cancelCategoryBtn.addEventListener('click', () => {
            addCategoryModal.classList.remove('show');
        });
    }

    // Close edit category modal
    const closeEditCategoryModal = document.getElementById('closeEditCategoryModal');
    const cancelEditCategoryBtn = document.getElementById('cancelEditCategoryBtn');

    if (closeEditCategoryModal) {
        closeEditCategoryModal.addEventListener('click', () => {
            editCategoryModal.classList.remove('show');
        });
    }

    if (cancelEditCategoryBtn) {
        cancelEditCategoryBtn.addEventListener('click', () => {
            editCategoryModal.classList.remove('show');
        });
    }

    // Close delete category modal
    const closeDeleteCategoryModal = document.getElementById('closeDeleteCategoryModal');
    const cancelDeleteCategoryBtn = document.getElementById('cancelDeleteCategoryBtn');

    if (closeDeleteCategoryModal) {
        closeDeleteCategoryModal.addEventListener('click', () => {
            deleteCategoryModal.classList.remove('show');
        });
    }

    if (cancelDeleteCategoryBtn) {
        cancelDeleteCategoryBtn.addEventListener('click', () => {
            deleteCategoryModal.classList.remove('show');
        });
    }

    // Close modals on background click
    [addCategoryModal, editCategoryModal, deleteCategoryModal].forEach(modal => {
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        }
    });

    // Event delegation for edit and delete buttons - ONLY for categories
    const categoriesSection = document.getElementById('categoriesSection');
    if (categoriesSection) {
        categoriesSection.addEventListener('click', function(e) {
            const editBtn = e.target.closest('.btn-edit');
            if (editBtn && editBtn.closest('.category-card')) {
                console.log('Edit category button clicked:', editBtn.dataset);
                openEditCategoryModal(editBtn);
                return; // Stop propagation
            }

            const deleteBtn = e.target.closest('.btn-delete');
            if (deleteBtn && deleteBtn.closest('.category-card')) {
                const categoryId = parseInt(deleteBtn.dataset.categoryId);
                const categoryName = deleteBtn.dataset.categoryName;
                confirmDeleteCategory(categoryId, categoryName);
                return; // Stop propagation
            }
        });
    }

    // Open edit category modal
    function openEditCategoryModal(editBtn) {
        const categoryId = editBtn.dataset.categoryId;
        const categoryName = editBtn.dataset.categoryName;
        const categoryDescription = editBtn.dataset.categoryDescription;

        console.log('Opening edit modal with data:', {
            categoryId, categoryName, categoryDescription
        });

        document.getElementById('editCategoryId').value = categoryId;
        document.getElementById('editCategoryName').value = categoryName || '';
        document.getElementById('editCategoryDescription').value = categoryDescription || '';

        editCategoryModal.classList.add('show');
    }

    // Confirm delete category
    function confirmDeleteCategory(categoryId, categoryName) {
        document.getElementById('deleteCategoryId').value = categoryId;
        document.getElementById('deleteCategoryName').textContent = categoryName;
        deleteCategoryModal.classList.add('show');
    }
});
</script>

</body>
</html>

