<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<!-- Fragment: Classes Section -->
<div th:fragment="section" class="section-block section-classes">
    <div class="section" id="classesSection">
        <div class="top-action">
            <h2>Lớp học</h2>
            <button class="create-btn" id="openAddClassModal" type="button">Thêm lớp học +</button>
        </div>
        <div class="divider"></div>

        <div th:if="${classSuccess}" class="alert success" th:text="${classSuccess}"></div>
        <div th:if="${classError}" class="alert error" th:text="${classError}"></div>

        <div th:if="${#lists.isEmpty(classes)}" class="empty-box">
            <img src="/img/empty-quiz.png" alt="Không có lớp học">
            <p>Chưa có lớp học nào</p>
        </div>

        <div th:if="${!#lists.isEmpty(classes)}" class="class-grid">
            <div class="class-card" th:each="c : ${classes}">
                <div class="class-card-image">
                    <img th:if="${c.imagePath != null}" th:src="${c.imagePath}" alt="Ảnh lớp">
                    <div th:if="${c.imagePath == null}" class="class-card-placeholder">
                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                    </div>
                </div>
                <div class="class-card-body">
                    <h3 class="class-card-title" th:text="${c.name}">Tên lớp</h3>
                    <p class="class-card-description" th:text="${c.description ?: 'Chưa có mô tả'}">Mô tả lớp học</p>
                    <div class="class-card-footer">
                        <span class="class-card-info">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            0 học viên
                        </span>
                        <div class="class-card-actions">
                            <button class="btn-icon btn-edit"
                                    th:data-class-id="${c.id}"
                                    th:data-class-name="${c.name}"
                                    th:data-class-description="${c.description}"
                                    th:data-class-image="${c.imagePath}"
                                    title="Chỉnh sửa">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="btn-icon btn-delete"
                                    th:data-class-id="${c.id}"
                                    th:data-class-name="${c.name}"
                                    title="Xóa">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 4 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Fragment: Classes Modals -->
<div th:fragment="modals">
    <!-- Modal thêm lớp học -->
    <div class="modal-overlay" id="addClassModal">
        <div class="modal-container">
            <div class="modal-topbar">
                <h3>Thêm lớp học mới</h3>
                <span class="close-btn" id="closeClassModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="addClassForm" method="post" action="/teacher/classes/create" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="className">Tên lớp học *</label>
                        <input type="text" id="className" name="name" class="input" required placeholder="Nhập tên lớp học">
                    </div>

                    <div class="form-group">
                        <label for="classDescription">Mô tả</label>
                        <textarea id="classDescription" name="description" class="input" rows="3" placeholder="Nhập mô tả lớp học"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="classImage">Hình ảnh lớp học</label>
                        <input type="file" id="classImage" name="image" class="input" accept="image/*">
                        <small style="color: #666; font-size: 13px;">Định dạng: JPG, PNG, GIF (tối đa 5MB)</small>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" id="cancelClassBtn">Hủy</button>
                        <button type="submit" class="btn-primary">Thêm lớp học</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa lớp học -->
    <div class="modal-overlay" id="editClassModal">
        <div class="modal-container">
            <div class="modal-topbar">
                <h3>Chỉnh sửa lớp học</h3>
                <span class="close-btn" id="closeEditClassModal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editClassForm" method="post" action="/teacher/classes/update" enctype="multipart/form-data">
                    <input type="hidden" id="editClassId" name="id">

                    <div class="form-group">
                        <label for="editClassName">Tên lớp học *</label>
                        <input type="text" id="editClassName" name="name" class="input" required placeholder="Nhập tên lớp học">
                    </div>

                    <div class="form-group">
                        <label for="editClassDescription">Mô tả</label>
                        <textarea id="editClassDescription" name="description" class="input" rows="3" placeholder="Nhập mô tả lớp học"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editClassImage">Hình ảnh lớp học</label>
                        <div id="currentImagePreview" style="margin-bottom: 10px; display: none;">
                            <img id="currentImage" style="max-width: 200px; border-radius: 8px; border: 1px solid #ddd;">
                        </div>
                        <input type="file" id="editClassImage" name="image" class="input" accept="image/*">
                        <small style="color: #666; font-size: 13px;">Chọn file mới để thay đổi ảnh</small>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" id="cancelEditClassBtn">Hủy</button>
                        <button type="submit" class="btn-primary">Lưu thay đổi</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal xác nhận xóa -->
    <div class="modal-overlay" id="deleteClassModal">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-topbar">
                <h3>Xác nhận xóa lớp học</h3>
                <span class="close-btn" id="closeDeleteClassModal">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin: 0 0 20px; color: #555;">Bạn có chắc chắn muốn xóa lớp học <strong id="deleteClassName"></strong>?</p>
                <p style="margin: 0 0 20px; color: #d9534f; font-size: 14px;">⚠️ Hành động này không thể hoàn tác!</p>

                <form id="deleteClassForm" method="post" action="/teacher/classes/delete">
                    <input type="hidden" id="deleteClassId" name="id">

                    <div class="modal-footer" style="margin-top: 0; padding-top: 0; border-top: none;">
                        <button type="button" class="btn-secondary" id="cancelDeleteClassBtn">Hủy</button>
                        <button type="submit" class="btn-danger">Xóa lớp học</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script th:fragment="scripts">
// Classes management scripts
document.addEventListener('DOMContentLoaded', function() {
    const addClassModal = document.getElementById('addClassModal');
    const editClassModal = document.getElementById('editClassModal');
    const deleteClassModal = document.getElementById('deleteClassModal');

    // Open add class modal
    const openAddClassBtn = document.getElementById('openAddClassModal');
    if (openAddClassBtn) {
        openAddClassBtn.addEventListener('click', () => {
            addClassModal.classList.add('show');
        });
    }

    // Close add class modal
    const closeClassModal = document.getElementById('closeClassModal');
    const cancelClassBtn = document.getElementById('cancelClassBtn');

    if (closeClassModal) {
        closeClassModal.addEventListener('click', () => {
            addClassModal.classList.remove('show');
        });
    }

    if (cancelClassBtn) {
        cancelClassBtn.addEventListener('click', () => {
            addClassModal.classList.remove('show');
        });
    }

    // Close edit class modal
    const closeEditClassModal = document.getElementById('closeEditClassModal');
    const cancelEditClassBtn = document.getElementById('cancelEditClassBtn');

    if (closeEditClassModal) {
        closeEditClassModal.addEventListener('click', () => {
            editClassModal.classList.remove('show');
        });
    }

    if (cancelEditClassBtn) {
        cancelEditClassBtn.addEventListener('click', () => {
            editClassModal.classList.remove('show');
        });
    }

    // Close delete class modal
    const closeDeleteClassModal = document.getElementById('closeDeleteClassModal');
    const cancelDeleteClassBtn = document.getElementById('cancelDeleteClassBtn');

    if (closeDeleteClassModal) {
        closeDeleteClassModal.addEventListener('click', () => {
            deleteClassModal.classList.remove('show');
        });
    }

    if (cancelDeleteClassBtn) {
        cancelDeleteClassBtn.addEventListener('click', () => {
            deleteClassModal.classList.remove('show');
        });
    }

    // Close modals on background click
    [addClassModal, editClassModal, deleteClassModal].forEach(modal => {
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        }
    });

    // Event delegation for edit buttons
    document.addEventListener('click', function(e) {
        const editBtn = e.target.closest('.btn-edit');
        if (editBtn) {
            console.log('Edit button clicked:', editBtn.dataset);
            openEditClassModal(editBtn);
        }

        const deleteBtn = e.target.closest('.btn-delete');
        if (deleteBtn) {
            const classId = parseInt(deleteBtn.dataset.classId);
            const className = deleteBtn.dataset.className;
            confirmDeleteClass(classId, className);
        }
    });

    // Open edit class modal
    function openEditClassModal(editBtn) {
        const classId = editBtn.dataset.classId;
        const className = editBtn.dataset.className;
        const classDescription = editBtn.dataset.classDescription;
        const classImage = editBtn.dataset.classImage;

        console.log('Opening edit modal with data:', {
            classId, className, classDescription, classImage
        });

        document.getElementById('editClassId').value = classId;
        document.getElementById('editClassName').value = className || '';
        document.getElementById('editClassDescription').value = classDescription || '';

        if (classImage && classImage !== 'null' && classImage !== '') {
            document.getElementById('currentImage').src = classImage;
            document.getElementById('currentImagePreview').style.display = 'block';
        } else {
            document.getElementById('currentImagePreview').style.display = 'none';
        }

        editClassModal.classList.add('show');
    }

    // Confirm delete class
    function confirmDeleteClass(classId, className) {
        document.getElementById('deleteClassId').value = classId;
        document.getElementById('deleteClassName').textContent = className;
        deleteClassModal.classList.add('show');
    }
});
</script>

</body>
</html>

