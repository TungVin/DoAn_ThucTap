<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- CSRF Token (nếu có Spring Security CSRF) -->
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>

  <!-- CSS -->
  <link rel="stylesheet" th:href="@{/css/exam-editor.css}">
  <title th:text="${mode == 'create' ? 'Tạo bài kiểm tra' : 'Chỉnh sửa bài kiểm tra'}">Exam</title>
  <link rel="stylesheet" href="/css/styles.css"> <!-- Import CSS file -->
</head>
<body>

<div class="page">

  <!-- FORM -->
  <form th:with="actionUrl=${mode == 'create' ? '/teacher/exams' : '/teacher/exams/' + examId}"
        th:action="@{${actionUrl}}"
        method="post"
        th:object="${form}"
        data-upload-url="/api/uploads">

<input type="hidden" name="questionsJson" id="questionsJson">

    <!-- TOPBAR -->
    <div class="topbar">
      <div>
        <div class="breadcrumb">
          <a th:href="@{/teacher(activeTab='exams')}">Bài kiểm tra</a>
          <span> / </span>
          <span th:text="${mode == 'create' ? 'Tạo mới' : 'Cài đặt'}">Tạo mới</span>
        </div>

        <h1 th:text="${mode == 'create' ? 'Tạo bài kiểm tra' : 'Cài đặt bài kiểm tra'}">Tạo bài kiểm tra</h1>
        <p class="muted">Thiết lập thông tin và thời gian. Bạn có thể chỉnh sửa bất kỳ lúc nào.</p>
      </div>

      <div class="actions">
        <a class="btn ghost" th:href="@{/teacher(activeTab='exams')}">Quay lại</a>
        <button class="btn primary" type="submit"
                th:text="${mode == 'create' ? 'Tạo bài kiểm tra' : 'Lưu thay đổi'}">
          Lưu
        </button>
      </div>
    </div>

    <!-- 2 CỘT: Thông tin chung + Thời gian -->
    <div class="grid">

      <!-- LEFT: Thông tin chung -->
      <section class="card">
        <div class="card-title">Thông tin chung</div>

        <label class="field">
          <span>Tiêu đề <b>*</b></span>
          <input class="input" th:field="*{title}" placeholder="Ví dụ: Kiểm tra chương 1" required>
        </label>

        <label class="field">
          <span>Mô tả</span>
          <textarea class="textarea" th:field="*{description}" placeholder="Mô tả ngắn về bài kiểm tra..."></textarea>
        </label>

        <label class="field">
          <span>Danh mục</span>
          <select class="input" th:field="*{categoryId}">
            <option value="">-- Chọn danh mục --</option>
            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
          </select>
        </label>

        <!-- Công khai -->
        <label class="field">
          <span>Công khai <b>*</b></span>
          <div class="switch-group">
            <input type="checkbox" th:field="*{isPublic}" id="publicCheckbox" />
            <span class="switch-label">Cho phép mọi người có link đều có thể làm bài kiểm tra này.</span>
          </div>
        </label>

        <!-- Đường link công khai (ẩn cho đến khi "Công khai" được tick) -->
        <div id="publicLinkSection" style="display: none;">
  <label class="field">
    <span>Link bài kiểm tra</span>
    <input type="text" id="publicLink" class="input" readonly>
    <button type="button" id="copyLinkBtn" class="btn small">Copy Link</button>
  </label>
</div>

      <!-- Thêm mới (Chỉ hiển thị khi "Công khai" không được tick) -->
      <div id="addNewContainer" style="display: none;">
        <div class="card">
          <div class="card-title">Riêng tư</div>
          <p>Chỉ thành viên trong nhóm được phép làm bài</p>
          
          <!-- Nút Thêm Thành Viên -->
          <button class="btn small" id="addNewBtn">+ Thêm Thành Viên</button>
          
          <!-- Thêm Nhóm -->
          <div class="add-group mt-3">
            <button type="button" id="addGroupBtn" class="btn btn-secondary">+ Thêm Nhóm</button>
          </div>
        </div>
      </div>

      <!-- Hiển thị danh sách nhóm đã thêm -->
      <ul id="groupList" class="mt-3">
        <!-- Các nhóm sẽ được thêm vào đây -->
      </ul>

      <!-- Modal for Thêm thành viên -->
      <div id="addMemberModal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Thành viên</h2>
            <span class="close-btn" id="closeModalBtn">&times;</span>
          </div>
          <div class="modal-body">
            <label for="memberEmail">Nhập email thành viên:</label>
            <input type="text" id="memberEmail" placeholder="Nhập email thành viên...">
            <button id="addMemberBtn" class="btn primary">Thêm thành viên</button>
            <div id="memberList" class="member-list">
              <p>Chưa có thành viên nào</p>
            </div>
          </div>
          <div class="modal-footer">
            <button id="saveBtn" class="btn primary">Xong</button>
            <button id="cancelBtn" class="btn ghost">Hủy</button>
          </div>
        </div>
      </div>

      <!-- Modal Thêm Nhóm -->
      <div id="addGroupModal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Chọn Lớp</h2>
            <span class="close-btn" id="closeGroupModalBtn">&times;</span>
          </div>
          <div class="modal-body">
            <label for="classSelect">Chọn lớp:</label>
            <select id="classSelect" class="input small">
              <option value="">-- Chọn lớp --</option>
              <!-- Danh sách lớp sẽ được thêm vào ở đây -->
              <option value="class1">Lớp 1</option>
              <option value="class2">Lớp 2</option>
              <option value="class3">Lớp 3</option>
            </select>
            <button id="addGroupSubmitBtn" class="btn primary">Thêm Nhóm</button>
          </div>
          <div class="modal-footer">
            <button id="closeGroupModalFooterBtn" class="btn ghost">Hủy</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Share + Time -->
      <section class="stack">
        <div class="card" th:if="${mode == 'edit'}">
          <div class="card-title">Chia sẻ</div>
          <div class="share-row">
            <input class="input" id="shareLink" th:value="${shareLink}" readonly>
            <button type="button" class="btn small" id="copyLinkBtn">Copy</button>
          </div>
          <p class="muted small">Gửi link này cho học sinh để vào làm bài.</p>
        </div>

        <!-- TIME SETTINGS -->
        <div class="card">
          <div class="card-title">Cài đặt thời gian</div>
          <div class="switch-row">
            <label class="toggle-switch">
              <input type="checkbox" th:field="*{timeLimitEnabled}" id="timeLimitEnabled">
              <span class="toggle-track"></span>
            </label>
            <label class="switch-text" for="timeLimitEnabled">
              <div class="label">Giới hạn thời gian làm bài</div>
              <div class="muted small">Tính từ lúc học sinh bắt đầu làm.</div>
            </label>
          </div>

          <div class="row">
            <input class="input" type="number" min="1" th:field="*{timeLimit}" id="timeLimit" placeholder="Số phút">
          </div>

          <hr class="sep"/>

          <!-- Thời gian bắt đầu -->
          <div class="switch-row">
            <label class="toggle-switch">
              <input type="checkbox" th:field="*{startEnabled}" id="startEnabled">
              <span class="toggle-track"></span>
            </label>
            <label class="switch-text" for="startEnabled">
              <div class="label">Thời gian bắt đầu</div>
              <div class="muted small">Không cho bắt đầu trước mốc này.</div>
            </label>
          </div>

          <div class="row two">
            <input class="input" type="date" th:field="*{startDate}" id="startDate">
            <input class="input" type="time" th:field="*{startTime}" id="startTime">
          </div>

          <!-- Thời gian kết thúc -->
          <div class="switch-row">
            <label class="toggle-switch">
              <input type="checkbox" th:field="*{endEnabled}" id="endEnabled">
              <span class="toggle-track"></span>
            </label>
            <label class="switch-text" for="endEnabled">
              <div class="label">Thời gian kết thúc</div>
              <div class="muted small">Hết hạn sau thời điểm này.</div>
            </label>
          </div>

          <div class="row two">
            <input class="input" type="date" th:field="*{endDate}" id="endDate">
            <input class="input" type="time" th:field="*{endTime}" id="endTime">
          </div>
        </div>
      </section>
    </div>

    <!-- HÀNG DƯỚI: FULL WIDTH (Cài đặt nâng cao + Phần 1) -->
    <section class="stack stack-wide">
      <div class="card">
        <div class="card-title">Cài đặt nâng cao</div>
        <label class="field">
          <span>Thời điểm hiển thị kết quả</span>
          <select class="input" th:field="*{resultDisplayMode}">
            <option th:value="AFTER_TEACHER_REVIEW">Sau khi giáo viên chấm bài</option>
            <option th:value="AFTER_EXAM_TIME_END">Sau khi kết thúc thời gian làm bài</option>
            <option th:value="AFTER_SUBMIT">Sau khi học sinh nộp bài</option>
          </select>
        </label>
      </div>

      <!-- PHẦN 1: CÂU HỎI -->
      <div class="card" id="questionSection">
        <div class="question-section-header">
          <div class="card-title">Phần 1</div>
          <select class="input small" id="part1Mode">
            <option value="none">Không trộn</option>
            <option value="shuffle_questions">Trộn thứ tự câu hỏi</option>
            <option value="shuffle_answers">Trộn thứ tự đáp án</option>
            <option value="shuffle_all">Trộn cả câu hỏi & đáp án</option>
          </select>
        </div>

        <div id="questionList" class="question-list">
          <!-- JS render câu hỏi vào đây -->
        </div>

        <button type="button" class="btn ghost full" id="addQuestionBtn">
          + Thêm câu hỏi
        </button>
      </div>
    </section>

  </form>
</div>

<script th:src="@{/js/exam-editor.js}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const addNewContainer = document.getElementById("addNewContainer");
    const addMemberContainer = document.getElementById("addMemberContainer");
    const publicCheckbox = document.getElementById("publicCheckbox");

    publicCheckbox.addEventListener("change", function() {
      if (!publicCheckbox.checked) {
        addNewContainer.style.display = "block"; // Hiển thị "Thêm mới"
        addMemberContainer.style.display = "block"; // Hiển thị "Thêm thành viên"
      } else {
        addNewContainer.style.display = "none"; // Ẩn "Thêm mới"
        addMemberContainer.style.display = "none"; // Ẩn "Thêm thành viên"
      }
    });

    // Khi nhấn vào "Thêm mới", hiển thị modal
    const addNewBtn = document.getElementById("addNewBtn");
    const modal = document.getElementById("addMemberModal");
    const closeModalBtn = document.getElementById("closeModalBtn");

    addNewBtn.addEventListener("click", () => {
      modal.style.display = "block";
    });

    // Khi nhấn vào nút đóng (x)
    closeModalBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // Khi nhấn vào nút "Hủy", đóng modal
    const cancelBtn = document.getElementById("cancelBtn");
    cancelBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // Khi nhấn vào nút "Thêm thành viên"
    const addMemberBtn = document.getElementById("addMemberBtn");
    addMemberBtn.addEventListener("click", () => {
      const email = document.getElementById("memberEmail").value;
      const memberList = document.getElementById("memberList");

      if (email) {
        const memberItem = document.createElement("p");
        memberItem.textContent = email;
        memberList.appendChild(memberItem);
        document.getElementById("memberEmail").value = ""; // Reset input
      }
    });

    // Khi nhấn vào "Xong", đóng modal
    const saveBtn = document.getElementById("saveBtn");
    saveBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });

    // Thêm Nhóm
    const addGroupBtn = document.getElementById("addGroupBtn");
    const addGroupModal = document.getElementById("addGroupModal");
    const closeGroupModalBtn = document.getElementById("closeGroupModalBtn");
    const closeGroupModalFooterBtn = document.getElementById("closeGroupModalFooterBtn");
    const addGroupSubmitBtn = document.getElementById("addGroupSubmitBtn");
    const classSelect = document.getElementById("classSelect");

    // Mở modal khi nhấn "Thêm Nhóm"
    addGroupBtn.addEventListener("click", () => {
      addGroupModal.style.display = "block";
    });

    // Đóng modal khi nhấn "X"
    closeGroupModalBtn.addEventListener("click", () => {
      addGroupModal.style.display = "none";
    });

    // Đóng modal khi nhấn "Hủy"
    closeGroupModalFooterBtn.addEventListener("click", () => {
      addGroupModal.style.display = "none";
    });

    // Xử lý khi nhấn "Thêm Nhóm"
    addGroupSubmitBtn.addEventListener("click", () => {
      const selectedClass = classSelect.value;
      if (selectedClass) {
        const groupList = document.getElementById("groupList");
        const groupItem = document.createElement("p");
        groupItem.textContent = `Nhóm: ${selectedClass}`;
        groupList.appendChild(groupItem);
        addGroupModal.style.display = "none"; // Đóng modal
      } else {
        alert("Vui lòng chọn lớp!");
      }
    });
  });
</script>

</body>
</html>
