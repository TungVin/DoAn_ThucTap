<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- CSRF Token (nếu có Spring Security CSRF) -->
  <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
  <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>

  <!-- CSS -->
  <link rel="stylesheet" th:href="@{/css/exam-editor.css}">
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <title th:text="${mode == 'create' ? 'Tạo bài kiểm tra' : 'Chỉnh sửa bài kiểm tra'}">Exam</title>
</head>

<body>
<div class="page">

  <!-- FORM -->
  <form th:with="actionUrl=${mode == 'create' ? '/teacher/exams' : '/teacher/exams/' + examId}"
        th:action="@{${actionUrl}}"
        method="post"
        th:object="${form}"
        data-upload-url="/api/uploads">

    <!-- hidden json submit -->
    <input type="hidden" name="questionsJson" id="questionsJson">

    <!-- TOPBAR -->
    <div class="topbar">
      <div>
        <div class="breadcrumb">
          <a th:href="@{/teacher(activeTab='exams')}">Bài kiểm tra</a>
          <span> / </span>
          <span th:text="${mode == 'create' ? 'Tạo mới' : 'Cài đặt'}">Tạo mới</span>
        </div>

        <h1 th:text="${mode == 'create' ? 'Tạo bài kiểm tra' : 'Cài đặt bài kiểm tra'}">Tạo bài kiểm tra</h1>
        <p class="muted">Thiết lập thông tin và thời gian. Bạn có thể chỉnh sửa bất kỳ lúc nào.</p>
      </div>

      <div class="actions">
        <a class="btn ghost" th:href="@{/teacher(activeTab='exams')}">Quay lại</a>
        <button class="btn primary" type="submit"
                th:text="${mode == 'create' ? 'Tạo bài kiểm tra' : 'Lưu thay đổi'}">
          Lưu
        </button>
      </div>
    </div>

    <!-- 2 CỘT: Thông tin chung + Thời gian -->
    <div class="grid">

      <!-- LEFT: Thông tin chung -->
      <section class="card">
        <div class="card-title">Thông tin chung</div>

        <label class="field">
          <span>Tiêu đề <b>*</b></span>
          <input class="input" th:field="*{title}" placeholder="Ví dụ: Kiểm tra chương 1" required>
        </label>

        <label class="field">
          <span>Mô tả</span>
          <textarea class="textarea" th:field="*{description}" placeholder="Mô tả ngắn về bài kiểm tra..."></textarea>
        </label>

        <label class="field">
          <span>Danh mục</span>
          <select class="input" th:field="*{categoryId}">
            <option value="">-- Chọn danh mục --</option>
            <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
          </select>
        </label>

        <!-- Công khai -->
        <label class="field">
          <span>Công khai <b>*</b></span>
          <div class="switch-group">
            <input type="checkbox" th:field="*{isPublic}" id="publicCheckbox" />
            <span class="switch-label">Cho phép mọi người có link đều có thể làm bài kiểm tra này.</span>
          </div>
        </label>

        <!-- Đường link công khai -->
        <div id="publicLinkSection"
             th:style="${form.isPublic} ? 'display:block;' : 'display:none;'">
          <label class="field">
            <span>Link bài kiểm tra</span>
            <input type="text"
                   id="publicLink"
                   class="input"
                   readonly
                   th:value="${mode == 'edit' ? shareLink : ''}"
                   placeholder="Tạo bài kiểm tra xong sẽ có link">
            <button type="button" id="copyPublicLinkBtn" class="btn small">Copy Link</button>
          </label>
        </div>

        <!-- Riêng tư -->
        <div id="addNewContainer"
             th:style="${form.isPublic} ? 'display:none;' : 'display:block;'">
          <div class="card">
            <div class="card-title">Riêng tư</div>
            <p>Chỉ thành viên trong nhóm được phép làm bài</p>

            <!-- Nút Thêm Thành Viên -->
            <button type="button" class="btn small" id="addNewBtn">+ Thêm Thành Viên</button>

            <!-- Thêm Nhóm -->
            <div class="add-group mt-3">
              <button type="button" id="addGroupBtn" class="btn btn-secondary">+ Thêm Nhóm</button>
            </div>
          </div>
        </div>

        <!-- Hiển thị danh sách nhóm đã thêm -->
        <ul id="groupList" class="mt-3"></ul>

        <!-- Modal for Thêm thành viên -->
        <div id="addMemberModal" class="modal" style="display: none;">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Thành viên</h2>
              <span class="close-btn" id="closeModalBtn">&times;</span>
            </div>
            <div class="modal-body">
              <label for="memberEmail">Nhập email thành viên:</label>
              <input type="text" id="memberEmail" placeholder="Nhập email thành viên...">
              <button type="button" id="addMemberBtn" class="btn primary">Thêm thành viên</button>
              <div id="memberList" class="member-list">
                <p>Chưa có thành viên nào</p>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="saveBtn" class="btn primary">Xong</button>
              <button type="button" id="cancelBtn" class="btn ghost">Hủy</button>
            </div>
          </div>
        </div>

        <!-- Modal Thêm Nhóm -->
        <div id="addGroupModal" class="modal" style="display: none;">
          <div class="modal-content">
            <div class="modal-header">
              <h2>Chọn Lớp</h2>
              <span class="close-btn" id="closeGroupModalBtn">&times;</span>
            </div>
            <div class="modal-body">
              <label for="classSelect">Chọn lớp:</label>
              <select id="classSelect" class="input small">
                <option value="">-- Chọn lớp --</option>
                <option value="class1">Lớp 1</option>
                <option value="class2">Lớp 2</option>
                <option value="class3">Lớp 3</option>
              </select>
              <button type="button" id="addGroupSubmitBtn" class="btn primary">Thêm Nhóm</button>
            </div>
            <div class="modal-footer">
              <button type="button" id="closeGroupModalFooterBtn" class="btn ghost">Hủy</button>
            </div>
          </div>
        </div>

      </section>

      <!-- RIGHT: Share + Time -->
      <section class="stack">

        <!-- Share (chỉ edit) -->
        <div class="card" th:if="${mode == 'edit'}">
          <div class="card-title">Chia sẻ</div>
          <div class="share-row">
            <input class="input" id="shareLink" th:value="${shareLink}" readonly>
            <button type="button" class="btn small" id="copyShareLinkBtn">Copy</button>
          </div>
          <p class="muted small">Gửi link này cho học sinh để vào làm bài.</p>
        </div>

        <!-- TIME SETTINGS -->
        <div class="card">
          <div class="card-title">Cài đặt thời gian</div>

          <div class="switch-row">
            <label class="toggle-switch">
              <input type="checkbox" th:field="*{timeLimitEnabled}" id="timeLimitEnabled">
              <span class="toggle-track"></span>
            </label>
            <label class="switch-text" for="timeLimitEnabled">
              <div class="label">Giới hạn thời gian làm bài</div>
              <div class="muted small">Tính từ lúc học sinh bắt đầu làm.</div>
            </label>
          </div>

          <div class="row">
            <input class="input" type="number" min="1" th:field="*{timeLimit}" id="timeLimit" placeholder="Số phút">
          </div>

          <hr class="sep"/>

          <!-- Thời gian bắt đầu -->
          <div class="switch-row">
            <label class="toggle-switch">
              <input type="checkbox" th:field="*{startEnabled}" id="startEnabled">
              <span class="toggle-track"></span>
            </label>
            <label class="switch-text" for="startEnabled">
              <div class="label">Thời gian bắt đầu</div>
              <div class="muted small">Không cho bắt đầu trước mốc này.</div>
            </label>
          </div>

          <div class="row two">
            <input class="input" type="date" th:field="*{startDate}" id="startDate">
            <input class="input" type="time" th:field="*{startTime}" id="startTime">
          </div>

          <!-- Thời gian kết thúc -->
          <div class="switch-row">
            <label class="toggle-switch">
              <input type="checkbox" th:field="*{endEnabled}" id="endEnabled">
              <span class="toggle-track"></span>
            </label>
            <label class="switch-text" for="endEnabled">
              <div class="label">Thời gian kết thúc</div>
              <div class="muted small">Hết hạn sau thời điểm này.</div>
            </label>
          </div>

          <div class="row two">
            <input class="input" type="date" th:field="*{endDate}" id="endDate">
            <input class="input" type="time" th:field="*{endTime}" id="endTime">
          </div>
        </div>

      </section>
    </div>

    <!-- HÀNG DƯỚI: FULL WIDTH (Cài đặt nâng cao + Phần 1) -->
    <section class="stack stack-wide">

      <div class="card">
        <div class="card-title">Cài đặt nâng cao</div>
        <label class="field">
          <span>Thời điểm hiển thị kết quả</span>
          <select class="input" th:field="*{resultDisplayMode}">
            <option th:value="AFTER_TEACHER_REVIEW">Sau khi giáo viên chấm bài</option>
            <option th:value="AFTER_EXAM_TIME_END">Sau khi kết thúc thời gian làm bài</option>
            <option th:value="AFTER_SUBMIT">Sau khi học sinh nộp bài</option>
          </select>
        </label>
      </div>

      <!-- PHẦN 1: CÂU HỎI -->
      <div class="card" id="questionSection">
        <div class="question-section-header">
          <div class="card-title">Phần 1</div>
          <select class="input small" id="part1Mode">
            <option value="none">Không trộn</option>
            <option value="shuffle_questions">Trộn thứ tự câu hỏi</option>
            <option value="shuffle_answers">Trộn thứ tự đáp án</option>
            <option value="shuffle_all">Trộn cả câu hỏi & đáp án</option>
          </select>
        </div>

        <div id="questionList" class="question-list">
          <!-- JS render câu hỏi vào đây -->
        </div>

        <button type="button" class="btn ghost full" id="addQuestionBtn">
          + Thêm câu hỏi
        </button>
      </div>

    </section>

  </form>
</div>

<!-- ✅ BƠM JSON TỪ SERVER TRƯỚC KHI LOAD JS -->
<script th:inline="javascript">
  window.__EXAM_MODE__ = /*[[${mode}]]*/ "create";
  window.__EXAM_ID__ = /*[[${examId}]]*/ null;
  window.__EXAM_QUESTIONS_JSON__ = /*[[${questionsJson}]]*/ "[]";
</script>

<!-- exam-editor.js sẽ đọc window.__EXAM_QUESTIONS_JSON__ để render lại câu hỏi khi edit -->
<script th:src="@{/js/exam-editor.js}"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const addNewContainer = document.getElementById("addNewContainer");
    const publicLinkSection = document.getElementById("publicLinkSection");
    const publicCheckbox = document.getElementById("publicCheckbox");

    // ===== Toggle Public/Private UI =====
    const applyPublicUI = () => {
      const isPublic = !!publicCheckbox?.checked;
      if (publicLinkSection) publicLinkSection.style.display = isPublic ? "block" : "none";
      if (addNewContainer) addNewContainer.style.display = isPublic ? "none" : "block";
    };

    if (publicCheckbox) {
      publicCheckbox.addEventListener("change", applyPublicUI);
      applyPublicUI(); // set initial
    }

    // ===== Copy link buttons =====
    const copyText = async (text) => {
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        alert("Đã copy link!");
      } catch (e) {
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        alert("Đã copy link!");
      }
    };

    const copyShareBtn = document.getElementById("copyShareLinkBtn");
    if (copyShareBtn) {
      copyShareBtn.addEventListener("click", () => {
        const shareLink = document.getElementById("shareLink")?.value || "";
        copyText(shareLink);
      });
    }

    const copyPublicBtn = document.getElementById("copyPublicLinkBtn");
    if (copyPublicBtn) {
      copyPublicBtn.addEventListener("click", () => {
        const publicLink = document.getElementById("publicLink")?.value || "";
        copyText(publicLink);
      });
    }

    // ===== Modal Thêm thành viên =====
    const addNewBtn = document.getElementById("addNewBtn");
    const modal = document.getElementById("addMemberModal");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const cancelBtn = document.getElementById("cancelBtn");
    const saveBtn = document.getElementById("saveBtn");

    if (addNewBtn && modal) {
      addNewBtn.addEventListener("click", () => modal.style.display = "block");
    }
    if (closeModalBtn && modal) {
      closeModalBtn.addEventListener("click", () => modal.style.display = "none");
    }
    if (cancelBtn && modal) {
      cancelBtn.addEventListener("click", () => modal.style.display = "none");
    }
    if (saveBtn && modal) {
      saveBtn.addEventListener("click", () => modal.style.display = "none");
    }

    const addMemberBtn = document.getElementById("addMemberBtn");
    if (addMemberBtn) {
      addMemberBtn.addEventListener("click", () => {
        const emailEl = document.getElementById("memberEmail");
        const memberList = document.getElementById("memberList");
        const email = emailEl?.value?.trim();

        if (!email || !memberList) return;

        const memberItem = document.createElement("p");
        memberItem.textContent = email;
        memberList.appendChild(memberItem);
        if (emailEl) emailEl.value = "";
      });
    }

    // ===== Modal Thêm nhóm =====
    const addGroupBtn = document.getElementById("addGroupBtn");
    const addGroupModal = document.getElementById("addGroupModal");
    const closeGroupModalBtn = document.getElementById("closeGroupModalBtn");
    const closeGroupModalFooterBtn = document.getElementById("closeGroupModalFooterBtn");
    const addGroupSubmitBtn = document.getElementById("addGroupSubmitBtn");
    const classSelect = document.getElementById("classSelect");

    if (addGroupBtn && addGroupModal) {
      addGroupBtn.addEventListener("click", () => addGroupModal.style.display = "block");
    }
    if (closeGroupModalBtn && addGroupModal) {
      closeGroupModalBtn.addEventListener("click", () => addGroupModal.style.display = "none");
    }
    if (closeGroupModalFooterBtn && addGroupModal) {
      closeGroupModalFooterBtn.addEventListener("click", () => addGroupModal.style.display = "none");
    }

    if (addGroupSubmitBtn) {
      addGroupSubmitBtn.addEventListener("click", () => {
        const selectedClass = classSelect?.value;
        if (!selectedClass) {
          alert("Vui lòng chọn lớp!");
          return;
        }

        const groupList = document.getElementById("groupList");
        if (!groupList) return;

        const groupItem = document.createElement("p");
        groupItem.textContent = `Nhóm: ${selectedClass}`;
        groupList.appendChild(groupItem);

        if (addGroupModal) addGroupModal.style.display = "none";
      });
    }
  });
</script>

</body>
</html>
