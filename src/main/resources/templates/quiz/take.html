<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title th:text="${exam.title}">Take Quiz</title>
  <link rel="stylesheet" th:href="@{/css/quiz.css}">
</head>

<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-inner">
    <div>
      <div style="font-weight:800" th:text="${exam.title}">Quiz</div>
      <div class="small">
        ƒê√£ tr·∫£ l·ªùi: <b id="answeredCount">0</b>/<b id="totalCount" th:text="${#lists.size(questions)}">0</b>
      </div>
    </div>

    <div style="display:flex; gap:12px; align-items:center">
      <div class="progress" aria-label="progress">
        <div id="progressBar"></div>
      </div>

      <!-- Timer (ch·ªâ hi·ªán khi c√≥ timeLimit) -->
      <div th:if="${exam.timeLimit != null}" class="timer" id="timer"
           th:attr="data-minutes=${exam.timeLimit}">
        ‚è± --:--
      </div>
    </div>
  </div>
</div>

<div class="container">

  <form th:action="@{/quiz/{id}/submit(id=${exam.id})}" method="post" id="quizForm">

    <div th:if="${#lists.isEmpty(questions)}" class="card">
      <h2>Ch∆∞a c√≥ c√¢u h·ªèi</h2>
      <p class="small">ƒê·ªÅ n√†y hi·ªán ch∆∞a c√≥ c√¢u h·ªèi. Vui l√≤ng li√™n h·ªá gi√°o vi√™n.</p>
      <div class="actions">
        <a class="btn ghost" th:href="@{/quiz/{id}(id=${exam.id})}">‚¨Ö Quay l·∫°i</a>
      </div>
    </div>

    <div th:each="q, st : ${questions}" class="q-card">
      <div class="q-head">
        <p class="q-title">
          C√¢u <span th:text="${st.index + 1}">1</span>
        </p>
        <div class="q-meta">
          ƒêi·ªÉm: <b th:text="${q.score}">1</b>
        </div>
      </div>

      <div th:text="${q.content}">N·ªôi dung c√¢u h·ªèi</div>

      <div class="options">
        <label class="option" th:each="opt : ${q.options}">
          <input type="radio"
                 th:name="${'q_' + q.id}"
                 th:value="${opt.id}">
          <div class="text">
            <div th:text="${opt.content}">ƒê√°p √°n</div>
            <div class="small" th:if="${opt.attachmentUrl != null and !#strings.isEmpty(opt.attachmentUrl)}">
              üìé <a th:href="${opt.attachmentUrl}" target="_blank">Xem t·ªáp ƒë√≠nh k√®m</a>
            </div>
          </div>
        </label>
      </div>
    </div>

    <!-- Sticky submit bar -->
    <div class="footer-actions" th:if="${!#lists.isEmpty(questions)}">
      <div class="inner">
        <div class="small">
          L∆∞u √Ω: ki·ªÉm tra ƒë√°p √°n tr∆∞·ªõc khi n·ªôp.
        </div>
        <div style="display:flex; gap:12px">
          <a class="btn ghost" th:href="@{/quiz/{id}(id=${exam.id})}">‚¨Ö Quay l·∫°i</a>
          <button type="submit" class="btn primary" onclick="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i?');">
            ‚úÖ N·ªôp b√†i
          </button>
        </div>
      </div>
    </div>

  </form>
</div>

<script>
  // Progress: ƒë·∫øm s·ªë c√¢u ƒë√£ ch·ªçn
  const form = document.getElementById('quizForm');
  const answeredEl = document.getElementById('answeredCount');
  const totalEl = document.getElementById('totalCount');
  const bar = document.getElementById('progressBar');

  function updateProgress(){
    const total = parseInt(totalEl?.textContent || '0', 10);
    if (!total) return;
    const names = new Set(Array.from(form.querySelectorAll('input[type="radio"]')).map(i => i.name));
    let answered = 0;
    names.forEach(n => {
      if (form.querySelector(`input[name="${n}"]:checked`)) answered++;
    });
    answeredEl.textContent = answered;
    bar.style.width = Math.round((answered / total) * 100) + '%';
  }

  if (form) {
    form.addEventListener('change', (e) => {
      if (e.target && e.target.matches('input[type="radio"]')) updateProgress();
    });
    updateProgress();
  }

  // Timer (n·∫øu c√≥)
  const timer = document.getElementById('timer');
  if (timer) {
    const minutes = parseInt(timer.getAttribute('data-minutes') || '0', 10);
    if (minutes > 0) {
      let remaining = minutes * 60;

      function render(){
        const m = Math.floor(remaining / 60);
        const s = remaining % 60;
        timer.textContent = `‚è± ${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;

        // ƒë·ªè khi c√≤n <= 1 ph√∫t
        if (remaining <= 60) timer.classList.add('danger');

        if (remaining <= 0) {
          timer.textContent = '‚è± 00:00';
          alert('H·∫øt gi·ªù! H·ªá th·ªëng s·∫Ω t·ª± n·ªôp b√†i.');
          document.getElementById('quizForm')?.submit();
          return;
        }
        remaining--;
        setTimeout(render, 1000);
      }
      render();
    }
  }
</script>

</body>
</html>
